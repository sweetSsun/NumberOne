<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
 <mapper namespace ="com.NumberOne.dao.BoardDao">
 	
 	<select id="selectNoticeList" resultType="com.NumberOne.dto.NoticeDto">
 		<!-- 공지 게시글 목록 조회 -->
 		SELECT NBCODE,NBMID,NBTITLE,NBCONTENTS,TO_CHAR(NBDATE,'YY-MM-DD') AS NBDATE,
 			   NBIMG,NBSTATE,NBHITS 
 		FROM NOTICEBOARDS
 	</select>
 	
 	<select id="selectBoardSearchList" resultType="com.NumberOne.dto.BoardDto">
 		<!-- 글검색 결과 조회 -->
 		SELECT BD.*, MB.MNICKNAME AS BDNICKNAME 
 		FROM BOARDS BD, MEMBERS MB
 		WHERE BD.BDMID = MB.MID 
 		
 		<if test="searchType == 'bdtitle' ">
 		<!-- 제목으로 검색 -->
 		AND BDTITLE LIKE '%'||#{searchText}||'%'
 		</if>
 		
 		<if test="searchType == 'bdcontents'">
 		<!-- 내용으로 검색 -->
 		AND BDCONTENTS LIKE '%'||#{searchText}||'%'
 		</if>
 		
 		<if test="searchType == 'bdtitlecontents'">
 		<!-- 제목 + 내용으로 검색  -->
 		AND BDTITLE LIKE '%'||#{searchText}||'%'
 		OR BDCONTENTS LIKE '%'||#{searchText}||'%'
 		</if>
 		
 		<if test="searchType == 'bdnickname'">
 		<!-- 닉네임으로 검색 -->
 		AND BDNICKNAME LIKE '%'||#{searchText}||'%'
 		</if>
 		
 		ORDER BY BDCODE DESC
 	 </select>
 	 
 	 <select id="selectRoomList" resultType="com.NumberOne.dto.BoardDto">
 	 	<!-- 자랑글 목록 -->
 	 	select bdcode, bdmid, bdtitle, bddate, bdimg, bdstate, bdhits, bdcontents,
		bdscrap, bdrecommend, bdreply, mnickname as bdnickname   	
		from boards b
		left outer join (select scbdcode, count(*) as bdscrap from scrap group by scbdcode) sc
		on b.bdcode = sc.scbdcode
		left outer join (select rcbdcode, count(*) as bdrecommend from recommend group by rcbdcode) rc
		on b.bdcode = rc.rcbdcode
		left outer join (select rpbdcode, count(*) as bdreply from reply group by rpbdcode) rp
		on b.bdcode = rp.rpbdcode
		left outer join members m
		on b.bdmid = m.mid
		where b.bdcategory='자랑'
		and b.bdstate='1'
		order by bdcode desc
	 </select>
 	 
 	 <select id="selectNoticeBoardView" resultType="com.NumberOne.dto.NoticeDto">	
	 	 <!-- 공지글 상세 -->
	 	 SELECT NBCODE,NBMID,NBTITLE,NBCONTENTS,TO_CHAR(NBDATE,'YY-MM-DD HH24:MI') AS NBDATE,
 			   NBIMG,NBSTATE,NBHITS  
	 	 FROM NOTICEBOARDS
	 	 WHERE NBCODE = #{nbcode}
 	 </select>
 	 
 	 <select id="selectBoardView" resultType="com.NumberOne.dto.BoardDto">
 	 	<!-- 일반글 상세 -->
 	 	SELECT BDCODE, BDRGCODE, BDCATEGORY, BDMID, BDTITLE, BDCONTENTS, TO_CHAR(BDDATE,'YY-MM-DD HH24:MI') AS BDDATE, 
	    BDIMG, BDDETAILIMG, BDSTATE, BDHITS, MB.MNICKNAME AS BDNICKNAME
		FROM BOARDS BD, MEMBERS MB
		WHERE BD.BDMID = MB.MID
		AND BD.BDCODE = #{bdcode}
 	 </select>
 	 

 	 <select id="selectRoomView" resultType="com.NumberOne.dto.BoardDto">
 	 	<!-- 자랑글 상세 -->
 	 	select bdcode, bdmid, bdtitle, bddate, bdimg, bdstate, bdhits, bdcontents,
		bdscrap, bdrecommend, bdreply, m.mnickname as bdnickname, m.mprofile as bdmprofile,
        sh.scmid as schistory, rch.rcmid as rchistory, wbh.wbmid as wbhistory
		from boards b
		left outer join (select scbdcode, count(*) as bdscrap from scrap group by scbdcode) sc
		on b.bdcode = sc.scbdcode
		left outer join (select rcbdcode, count(*) as bdrecommend from recommend group by rcbdcode) rc
		on b.bdcode = rc.rcbdcode
		left outer join (select rpbdcode, count(*) as bdreply from reply group by rpbdcode) rp
		on b.bdcode = rp.rpbdcode
		left outer join members m
		on b.bdmid = m.mid
        left outer join (select * from scrap where scmid=#{loginId}) sh on b.bdcode = sh.scbdcode
        left outer join (select * from recommend where rcmid=#{loginId}) rch on b.bdcode = rch.rcbdcode
        left outer join (select * from warningboards where wbmid=#{loginId}) wbh on b.bdcode = wbh.wbedbdcode
        
		where b.bdcategory='자랑'
		and b.bdstate='1'
        and b.bdcode=#{bdcode}
        order by bdcode desc
 	 </select>

 	 <select id="selectReplyMaxNumber" resultType="String">
 	 	<!-- 댓글 최대번호 조회 -->
 	 	SELECT MAX(RPCODE) 
 	 	FROM REPLY
 	 </select>
 	 
 	<insert id="insertBoardReply_ajax">
 		<!-- 댓글등록 -->
 		INSERT INTO REPLY(RPCODE, RPBDCODE, RPCONTENTS, RPMID, RPDATE)
 		VALUES ( #{rpcode}, #{rpbdcode}, #{rpcontents}, #{rpmid}, SYSDATE )
 	</insert>
 	
 	<select id="selectBoardReplyList" resultType="com.NumberOne.dto.ReplyDto">
 		<!-- 댓글목록 조회 -->
 		SELECT RP.*, MB.MNICKNAME AS RPNICKNAME
		FROM REPLY RP, MEMBERS MB 
		WHERE RP.RPMID = MB.MID
		AND RPBDCODE = #{bdcode}
		AND RPSTATE = 1 
 		ORDER BY RPCODE 
 	</select>
 	
 	<select id="selectReplyCount_ajax" resultType="int">
 		<!-- 댓글개수 조회 -->
 		SELECT COUNT(*)
		FROM REPLY 
		WHERE RPBDCODE = #{bdcode}
		AND RPSTATE = 1
 	</select>
 	 
 	<update id="updateReplyState_ajax">
 		<!-- 댓글상태 변경 -->
 		UPDATE REPLY 
 		SET RPSTATE = 0
 		WHERE RPCODE = #{rpcode}
 	</update> 
 	 
 	<insert id="insertBoardRecommend_ajax">
 		<!-- 게시글 추천 -->
 		INSERT INTO RECOMMEND
 		VALUES ( #{loginId}, #{bdcode} )
 	</insert> 
 	
 	
 	<insert id="insertBoardWarning_ajax">
 		<!-- 게시글 신고 -->
 		INSERT INTO WARNINGBOARDS 
 		VALUES ( #{loginId}, #{bdcode} )
 	</insert>
 	 
 	<select id="selectBoardRecommendCount_ajax" resultType="int">
 		<!-- 게시글 추천수 조회 -->
 		SELECT COUNT(*)
		FROM RECOMMEND
		WHERE RCBDCODE = #{bdcode}
 	</select>
 	 
 	<update id="updateRoomhits">
 		<!-- 조회수 올리기-->
 		UPDATE Boards
 		SET bdhits = bdhits +1
 		WHERE bdCODE = #{bdcode}
 	</update> 

	<select id="selectCurrentHisroty" resultType="String">
		select count(*) from 
		
		<if test="history == 'rchistory' ">
			recommend where rcbdcode = #{bdcode} 
			and rcmid=#{loginId}
		</if>
		<if test="history == 'schistory'">	
			scrap where scbdcode = #{bdcode}
			and scmid=#{loginId}
		</if>	
		<if test="history == 'wbhistory'">
			warningboards where wbedbdcode=#{bdcode}
			and wbmid=#{loginId}
		</if>	
	</select>
	
	<delete id="deleteState">
		delete from 
		<if test="history == 'rchistory' ">
			recommend where rcbdcode = #{bdcode} 
			and rcmid=#{loginId}
		</if>
		<if test="history == 'schistory'">	
			scrap where scbdcode = #{bdcode}
			and scmid=#{loginId}
		</if>	
		<if test="history == 'wbhistory'">
			warningboards where wbedbdcode=#{bdcode}
			and wbmid=#{loginId}
		</if>
	</delete>
	
	<insert id="insertState">
		insert into 
		<if test="history == 'rchistory' ">
			recommend 
		</if>
		<if test="history == 'schistory'">	
			scrap 
		</if>	
		<if test="history == 'wbhistory'">
			warningboards
		</if>
		values (#{loginId}, #{bdcode})
	</insert>
	
 </mapper>
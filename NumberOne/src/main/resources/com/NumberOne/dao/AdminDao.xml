<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.NumberOne.dao.AdminDao">


	<!-- 회원 관리 -->
	<select id="admin_selectMemberTotalCount" resultType="int">
		SELECT COUNT(*)
		FROM MEMBERS MB
		    LEFT OUTER JOIN (SELECT WMEDMID, COUNT(WMEDMID) MWARNING FROM WARNINGMEMBERS GROUP BY WMEDMID) WM
		    ON MB.MID = WM.WMEDMID
    	<if test="searchVal == 'active'">
			WHERE MSTATE=1 AND MWARNING IS NULL
		</if>
		<if test="searchVal == 'warning'">
			WHERE WM.MWARNING > 0
		</if>
		<if test="searchVal == 'inactive'">
			WHERE MSTATE=0
		</if>
		<if test="searchVal == 'withdraw'">
			WHERE MSTATE=2
		</if>
	</select>

	<select id="admin_selectMemberList" resultType="com.NumberOne.dto.MemberDto">
		SELECT MID, MPW, MNAME, MNICKNAME, MPHONE, MEMAIL, MADDR, MPROFILE, MMESSAGE, MSTATE, TO_CHAR(MJOINDATE,'YYYY-MM-DD') MJOINDATE, MWARNING
		FROM
			(SELECT ROWNUM RN, MID, MPW, MNAME, MNICKNAME, MPHONE, MEMAIL, MADDR, MPROFILE, MMESSAGE, MSTATE, MJOINDATE, NVL(WM.MWARNING, 0) MWARNING
			FROM MEMBERS MB
			    LEFT OUTER JOIN (SELECT WMEDMID, COUNT(WMEDMID) MWARNING FROM WARNINGMEMBERS GROUP BY WMEDMID) WM
			    ON MB.MID = WM.WMEDMID
			<if test="searchVal == 'active'">
				WHERE MSTATE=1 AND MWARNING IS NULL
			</if>
			<if test="searchVal == 'warning'">
				WHERE WM.MWARNING > 0
			</if>
			<if test="searchVal == 'inactive'">
				WHERE MSTATE=0
			</if>
			<if test="searchVal == 'withdraw'">
				WHERE MSTATE=2
			</if>
			ORDER BY MJOINDATE)
		WHERE RN BETWEEN ${startRow} AND ${endRow}
		
	</select>

	<update id="admin_updateMstate_ajax">
		UPDATE MEMBERS SET MSTATE=${mstate}
		WHERE MID=#{mid}
	</update>
	
	<select id="admin_selectMemberInfo_ajax" resultType="com.NumberOne.dto.MemberDto">
		SELECT MID, MPW, MNAME, MNICKNAME, MPHONE, MEMAIL, MADDR, MPROFILE, MMESSAGE, MSTATE, TO_CHAR(MJOINDATE,'YYYY-MM-DD') MJOINDATE, NVL(WM.MWARNING, 0) MWARNING
		FROM MEMBERS MB
		    LEFT OUTER JOIN (SELECT WMEDMID, COUNT(WMEDMID) MWARNING FROM WARNINGMEMBERS GROUP BY WMEDMID) WM
		    ON MB.MID = WM.WMEDMID
		 WHERE MID=#{mid}
	</select>
	
	<!-- 공지 관리 -->
	<!-- 페이징 위한 공지 총 갯수 조회 -->
	<select id="admin_selectNoticeTotalCount" resultType="int">
		SELECT COUNT(*)
		FROM NOTICEBOARDS
		<if test="keyword.length > 0 || searchVal == 'active' || searchVal == 'inactive'">
			WHERE
			<!-- 검색한 키워드 정렬 -->
			<if test="keyword.length > 0">
				<choose>
					<when test="searchType == 'nbTitleContents'">
						(NBTITLE LIKE '%'||#{keyword}||'%' OR NBCONTENTS LIKE '%'||#{keyword}||'%')
					</when>
					<otherwise>
						${searchType} LIKE '%'||#{keyword}||'%'
					</otherwise>				
				</choose>
				<if test="searchVal == 'active' || searchVal == 'inactive'">
						AND
				</if>
			</if>
		</if>
		<!-- 상태값에 따른 정렬 -->
		<if test="searchVal == 'active'">
			NBSTATE=1
		</if>
		<if test="searchVal == 'inactive'">
			NBSTATE=0
		</if>
	</select>
	
	<!-- 페이징처리 후의 쿼리문 -->
 	<select id="admin_selectNoticeList" resultType="com.NumberOne.dto.NoticeDto">
		SELECT NBCODE, NBMID, NBTITLE, NBCONTENTS, TO_CHAR(NBDATE, 'MM-DD') NBDATE, NBIMG, NBSTATE, NBHITS
		FROM
			(SELECT ROWNUM RN, NBCODE, NBMID, NBTITLE, NBCONTENTS, NBDATE, NBIMG, NBSTATE, NBHITS
			FROM NOTICEBOARDS
			<if test="keyword.length > 0 || searchVal == 'active' || searchVal == 'inactive'">
				WHERE
				<!-- 검색한 키워드 정렬 -->
				<if test="keyword.length > 0">
					<choose>
						<when test="searchType == 'nbTitleContents'">
							(NBTITLE LIKE '%'||#{keyword}||'%' OR NBCONTENTS LIKE '%'||#{keyword}||'%')
						</when>
						<otherwise>
							${searchType} LIKE '%'||#{keyword}||'%'
						</otherwise>				
					</choose>
					<if test="searchVal == 'active' || searchVal == 'inactive'">
							AND
					</if>
				</if>
			</if>
			<!-- 상태값에 따른 정렬 -->
			<if test="searchVal == 'active'">
				NBSTATE=1
			</if>
			<if test="searchVal == 'inactive'">
				NBSTATE=0
			</if>
			ORDER BY NBCODE)
		WHERE RN BETWEEN ${startRow} AND ${endRow}
			
	</select>
	 
	 <!-- 공지 상태 변경 -->
	<update id="admin_updateNbstate_ajax">
		UPDATE NOTICEBOARDS 
		SET NBSTATE=${nbstate}
		WHERE NBCODE=#{nbcode}
	</update>
	
	<select id="admin_selectMaxNbcode" resultType="String">
		SELECT NVL(MAX(NBCODE),NB00000) FROM NOTICEBOARDS
	</select>
	
	<insert id="admin_insertNoticeWrite">
		INSERT INTO NOTICEBOARDS (NBCODE, NBMID, NBTITLE, NBCONTENTS, NBDATE, NBIMG)
		VALUES (#{nbcode}, #{nbmid}, #{nbtitle}, #{nbcontents}, SYSDATE, #{nbimg})
	</insert>
	
	<update id="admin_updateNoticeModify">
		UPDATE NOTICEBOARDS SET NBTITLE=#{nbtitle}, NBCONTENTS=#{nbcontents}
		WHERE NBCODE=#{nbcode}
	</update>
</mapper>
